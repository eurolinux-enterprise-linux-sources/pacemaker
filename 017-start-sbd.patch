From e8f8410efc068b498c476b1fa7d86c976cad27dd Mon Sep 17 00:00:00 2001
From: Klaus Wenninger <klaus.wenninger@aon.at>
Date: Tue, 26 Jul 2016 15:14:09 +0200
Subject: [PATCH] LSB init: start/stop SBD with pacemaker

---
 lrmd/pacemaker_remote.in | 13 +++++++++++++
 mcp/pacemaker.in         | 12 +++++++++++-
 2 files changed, 24 insertions(+), 1 deletion(-)

diff --git a/lrmd/pacemaker_remote.in b/lrmd/pacemaker_remote.in
index 13abba1..a356510 100644
--- a/lrmd/pacemaker_remote.in
+++ b/lrmd/pacemaker_remote.in
@@ -66,6 +66,7 @@ if [ -d @CONFIGDIR@ ]; then
 	[ -f @INITDIR@/functions ] && . @INITDIR@/functions
 set -a
 	[ -f @CONFIGDIR@/pacemaker ] && . @CONFIGDIR@/pacemaker
+	[ -f @CONFIGDIR@/sbd ] && . @CONFIGDIR@/sbd
 set +a
 fi
 
@@ -77,6 +78,14 @@ elif [ -d "@localstatedir@/lock" ]; then
 fi
 [ -z "$LOCK_FILE" ] && LOCK_FILE="$LOCK_DIR/pacemaker_remote"
 
+# Check if there is a valid watchdog-device configured in sbd config
+if [ x != "x$SBD_WATCHDOG_DEV" -a "/dev/null" != "$SBD_WATCHDOG_DEV" -a -c "$SBD_WATCHDOG_DEV" ]; then
+	# enhance for unavailable chkconfig - don't touch sbd for now
+	if chkconfig --list sbd_remote_helper 2>/dev/null | grep -q ":on"; then
+		SBD_SERVICE=sbd_remote_helper
+	fi
+fi
+
 start()
 {
 	echo -n "Starting $desc: "
@@ -105,6 +114,8 @@ start()
 		fi
 	fi
 	echo
+
+	[ "x$SBD_SERVICE" != x ] && service $SBD_SERVICE start
 }
 
 stop()
@@ -126,6 +137,8 @@ stop()
 	rm -f "@localstatedir@/run/$prog.pid"
 	success
 	echo
+
+	[ "x$SBD_SERVICE" != x ] && service $SBD_SERVICE stop
 }
 
 rtrn=0
diff --git a/mcp/pacemaker.in b/mcp/pacemaker.in
index 90335db..0ff1ac1 100644
--- a/mcp/pacemaker.in
+++ b/mcp/pacemaker.in
@@ -77,6 +77,7 @@ if [ -d @CONFIGDIR@ ]; then
 	[ -f @INITDIR@/functions ] && . @INITDIR@/functions
 set -a
 	[ -f @CONFIGDIR@/pacemaker ] && . @CONFIGDIR@/pacemaker
+	[ -f @CONFIGDIR@/sbd ] && . @CONFIGDIR@/sbd
 set +a
 fi
 
@@ -93,6 +94,14 @@ if [ x = "x$PCMK_STACK" -a -f "@sysconfdir@/cluster/cluster.conf" ]; then
     PCMK_STACK=cman
 fi
 
+# Check if there is a valid watchdog-device configured in sbd config
+if [ x != "x$SBD_WATCHDOG_DEV" -a "/dev/null" != "$SBD_WATCHDOG_DEV" -a -c "$SBD_WATCHDOG_DEV" ]; then
+	# enhance for unavailable chkconfig - don't touch sbd for now
+	if chkconfig --list sbd_helper 2>/dev/null | grep -q ":on"; then
+		SBD_SERVICE=sbd_helper
+	fi
+fi
+
 start()
 {
 	notify "Starting $desc"
@@ -137,7 +146,7 @@ cman_pre_start()
     fi
 
     # start cman's friends if they're not running but were configured to start automatically
-    for cservice in cmirrord clvmd gfs2; do
+    for cservice in cmirrord clvmd gfs2 $SBD_SERVICE; do
 	chkconfig --list $cservice 2>/dev/null | grep -q ":on"
 	if [ $? -eq 0 ]; then
 	    service $cservice status >/dev/null 2>&1
@@ -274,6 +283,7 @@ stop)
 	#
 	[ "$PCMK_STACK" = cman ] && cman_pre_stop
 	stop
+	[ "x$SBD_SERVICE" != x ] && service $SBD_SERVICE stop
 
 	# Stop cman if needed, unless --skip-cman is specified (which allows
 	# higher-level tooling to stop pacemaker on all nodes, then stop cman
-- 
1.8.3.1

